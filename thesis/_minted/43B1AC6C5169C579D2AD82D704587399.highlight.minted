\begin{MintedVerbatim}[commandchars=\\\{\}]
\PYG{k}{def}\PYG{+w}{ }\PYG{n+nf}{paged\PYGZus{}attention}\PYG{p}{(}\PYG{n}{query}\PYG{p}{,} \PYG{n}{block\PYGZus{}table}\PYG{p}{,} \PYG{n}{k\PYGZus{}cache}\PYG{p}{,} \PYG{n}{v\PYGZus{}cache}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{output} \PYG{o}{=} \PYG{n}{zeros\PYGZus{}like}\PYG{p}{(}\PYG{n}{query}\PYG{p}{)}

    \PYG{k}{for} \PYG{n}{logical\PYGZus{}idx}\PYG{p}{,} \PYG{p}{(}\PYG{n}{physical\PYGZus{}idx}\PYG{p}{,} \PYG{n}{filled}\PYG{p}{)} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n}{block\PYGZus{}table}\PYG{p}{)}\PYG{p}{:}
        \PYG{c+c1}{\PYGZsh{} Fetch non\PYGZhy{}contiguous KV blocks}
        \PYG{n}{k\PYGZus{}block} \PYG{o}{=} \PYG{n}{k\PYGZus{}cache}\PYG{p}{[}\PYG{n}{physical\PYGZus{}idx}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{n}{filled}\PYG{p}{]}
        \PYG{n}{v\PYGZus{}block} \PYG{o}{=} \PYG{n}{v\PYGZus{}cache}\PYG{p}{[}\PYG{n}{physical\PYGZus{}idx}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{p}{,} \PYG{p}{:}\PYG{n}{filled}\PYG{p}{]}

        \PYG{c+c1}{\PYGZsh{} Compute attention for this block}
        \PYG{n}{scores} \PYG{o}{=} \PYG{n}{query} \PYG{o}{@} \PYG{n}{k\PYGZus{}block}\PYG{o}{.}\PYG{n}{T} \PYG{o}{/} \PYG{n}{sqrt}\PYG{p}{(}\PYG{n}{head\PYGZus{}dim}\PYG{p}{)}
        \PYG{c+c1}{\PYGZsh{} Accumulate with proper softmax normalization}
        \PYG{n}{output} \PYG{o}{+}\PYG{o}{=} \PYG{n}{softmax}\PYG{p}{(}\PYG{n}{scores}\PYG{p}{)} \PYG{o}{@} \PYG{n}{v\PYGZus{}block}

    \PYG{k}{return} \PYG{n}{output}
\end{MintedVerbatim}
